<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instructor Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    #chatMessages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 1rem;
      background: white;
      border-radius: 0.5rem;
    }
    .chat-bubble {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      max-width: 75%;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 id="chatHeading" class="text-3xl font-bold text-indigo-700 mb-6">ðŸ’¬ Chat</h1>

    <div id="chatMessages" class="mb-4"></div>

    <form id="chatForm" class="flex space-x-2">
      <input type="text" id="messageInput" class="flex-grow border border-gray-300 rounded px-4 py-2" placeholder="Type your message..." required />
      <button type="submit" class="bg-indigo-600 text-white px-6 rounded hover:bg-indigo-700 transition">Send</button>
    </form>
  </div>

  <script>
    const BACKEND_URL = 'http://localhost:3000';

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('student_id') || localStorage.getItem('student_id');
    const studentName = urlParams.get('student_name') || 'Student';
    const instructorId = localStorage.getItem('instructor_id');
    const instructorName = localStorage.getItem('instructor_name');

    if (!studentId || !instructorId) {
      alert('Missing student or instructor information. Redirecting...');
      window.location.href = 'i_dashboard.html';
    }

    // Set heading dynamically
    document.getElementById('chatHeading').textContent = `ðŸ’¬ Chat with ${studentName}`;

    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, tag => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[tag]));
    }

    function loadChatMessages() {
      fetch(`${BACKEND_URL}/api/chat?student_id=${studentId}&instructor_id=${instructorId}`)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(data => displayChatMessages(data))
        .catch(err => {
          chatMessages.innerHTML = `<p class="text-red-600">Failed to load chat messages: ${err.message}</p>`;
        });
    }

    function displayChatMessages(messages) {
      chatMessages.innerHTML = '';
      if (messages.length === 0) {
        chatMessages.innerHTML = '<p class="text-center text-gray-500 mt-32">No messages yet.</p>';
        return;
      }

      messages.forEach(msg => {
        const isInstructor = msg.sender_role === 'instructor' && msg.sender_id == instructorId;
        const msgWrapper = document.createElement('div');
        msgWrapper.className = `mb-3 ${isInstructor ? 'text-right' : 'text-left'}`;

        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${isInstructor ? 'bg-indigo-200 text-right' : 'bg-yellow-200 text-left'}`;
        bubble.textContent = escapeHTML(msg.message);

        const timestamp = document.createElement('div');
        timestamp.className = 'text-xs text-gray-500 mt-1';
        timestamp.textContent = `${isInstructor ? 'You' : studentName} â€¢ ${new Date(msg.timestamp).toLocaleTimeString()}`;

        msgWrapper.appendChild(bubble);
        msgWrapper.appendChild(timestamp);
        chatMessages.appendChild(msgWrapper);
      });

      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      const message = messageInput.value.trim();
      if (!message) return;

      fetch(`${BACKEND_URL}/api/chat/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sender_role: 'instructor',
          sender_id: instructorId,
          receiver_id: studentId,
          message: message
        })
      })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (data.success) {
          messageInput.value = '';
          loadChatMessages();
        } else {
          alert('Failed to send message');
        }
      })
      .catch(err => {
        alert('Error sending message: ' + err.message);
      });
    });

    // Initial load and auto-refresh
    loadChatMessages();
    setInterval(loadChatMessages, 5000);
  </script>
</body>
</html>
